#iOS 应用架构现状分析
本文就**iOS**架构这一主题, 结合开发圈里讨论较多的几种主流方式, 再配以自己的理解, 做下现状分析. 给自己做下知识梳理的同时, 也期望能引入新的思考.

##架构的定义
过去的大部分时间都浸淫在iOS平台, 翻阅过不少关于架构的文章, 发现众人对架构的理解颇有些差异, 总体来说可以分为四类:

###第一类: 精简型应用架构
这类架构的文章分析主要还是围绕**MVC**展开, 以苹果自带**UIViewController**优劣为出发点, 再结合主流的**MVP**, **MVVM**, **MVCS**等变种进行分析演变. 这类的探讨重点在于M, V, C三类角色的定义以及之间的数据事件流向的规范. 很多小型应用所面临的问题及其架构层面的解决方案都集中在这一类. 

###第二类: 综合型应用架构
对于用户量级在千万级或以上的应用来说, **MVC**这一层面的思考已无法应对业务疯狂增长所带来的负担. 这类应用往往需要专业资深的架构师出面进行深层次的思考设计, 业内不少大厂如淘宝, 天猫, 携程等都做过一些分享. 不过到了这一层级的战斗, 不光考验架构师的技术积累, 更重要的是架构师对于业务的整理理解. 姑且将这类架构名之为: 综合性应用架构. 综合性应用架构一般不会提及**MVC**, 更多是在探讨**层**与**模块**的划分和耦合.

###第三类: 深度优化的综合性应用架构
综合性应用架构是应对大规模业务增长的必经之路, 一旦架构成型, 后期业务膨胀会不停的打磨架构本身, 产品本身对体验质量的追求会要求架构师和技术团队不停的优化架构细节. 这种优化细节可以分为两块: 第一是组件和模块划分的粒度越来越细, 第二是组件模块的深度优化, 比如网络层的深度优化, sqlite优化(多线程, FTS, 安全等), 数据加密, HotFix, Hybid等.一些开源的第三方库已不能满足要求, 需要团队自己重造轮子. 这一层面的架构设计涉及面广, 对架构师, 团队技术人员的技术深度和业务理解能力有较高要求, 短短一篇技术文章往往只能走马观花的介绍个大概, 每一次优化几乎都可以作为一个专题来讲解.

###第四类: 组织型应用架构
这类架构在第三类的基础之上更进了一步，除了关注系统层面的架构设计之外, 更对团队或部门之间协作方式, 各系统模块的演进方式,产品发布流程等都作出了规范. 除去业务膨胀带来的压力, 人员增长,各团队协作依赖增强都会对app的质量, 迭代速度产生影响, 这些问题也需要从架构层面去解决. 这类结合技术架构和组织架构的分享还比较少.

以上四种类型的架构又可以看作一般APP从简至繁， 公司规模随之增长的演进过程, 技术圈绝大部分的架构类分享文章都可以归为上述四类.

对于什么是**架构**的学术定义, 似乎大家并不太在意, 更关心的是如何解决自身项目当下的问题. 虽然在我看来第一类架构更像是讨论设计模式, 但这里面确实又有非常多的知识可以深入挖掘, 这里就把所有**解决应用整体设计问题**的讨论都归于架构这一话题.

###样本分析
####第一类样本:
如果一篇架构的文章是以讨论**MVC**为起点, 很有可能作者所说的架构就可以被归为第一类样本.

**Xcode**自带的**UIViewController**模版经常被戏称为**Massive View Controller**, 主要是因为**UIViewController**除了复责**Controller**生命周期回调之外, 还承担了**View**和**Controller**的工作. 不少架构的探讨以此为基础, 将**Controller**的M, V, C这三个角色重新划分, 又或者衍生出**MVP**, **MVVM**, **MVCS**, **VIPER**等其他组织方式. 重新定义**MVC**之后, 网络访问, 持久化, 安全等通用功能模块往往就由**Controller**或者**Presenter(提出者)**负责
了, 这些负责业务逻辑的功能直接依赖于成熟稳定的第三方基础库, 比如**AFN**, **FMDB**....

但是，应付过负责庞大业务模块的工程师会有经验, 无论以何种方式组织**Controlelr**, 数据流向和事件传递再清晰合理, 单纯代码量的膨胀就足以让**Controller**变得难以维护.**MVC**, **MVP**, **MVVM**都可以变得**Massive**.想象一下将10本书放在床头, 你可以按翻阅频次, 阅读习惯将书合理摆放, 但当你面对100本书的时候, 已不是如何摆放的问题, 而是需要一个书柜. 说到这里我挺服**VIPER**的, 五个角色划分, 尝试可以在床头放下100本书的**Pattern**.

样本名字: iOS架构模式 - 解密MVC, MVP, MVVM以及VIPER架构
[英文原版](https://medium.com/ios-os-x-development/ios-architecture-patterns-ecba4c38de52) [中文翻译](http://ios.jobbole.com/83727/)

这篇文章是第一类样本的典型, 综合对比了MV(X)系列架构, 我们来看下主要论点.
 
**论点摘要**
文章认为优秀的架构具备一下三个特质: 

```c
Balanced distribution of responsibilities among entities with strict roles. 
能把代码职责均衡的划分到不同的功能类里.
```

这是我们关注架构的原动力, 有个粗浅的评价标准, 同一个业务单位(Controller)里面, 不能一个类1000多行代码, 另一个类却只有10来行. 当我们考虑网络请求的代码是该放在Controller当中还是modal当中的时候， 在**代码量**上要做到**雨露均沾**, 不能少数类**营养不良**. 所以不论你的MVC, MVP或者VIPER是如何划分职责的, 各个角色所承担的职责应当看起来是均匀分配的.


```c
Testability usually comes from the first feature.
方便测试
```

测试是个有趣的话题， 不同公司实践差异很大. 对于开发人员的自测情况, 如果代码架构清晰, 各个角色分配合理, 易测性是随之而来的副产品.


```c
Ease of use and a low maintenance cost
易用且方便维护
```

易用是针对团队里的开发人员而言的, 其实到底是用MVP还是MVVM， 或者MVV里数据如何流动, 这些具体的规范到底采用何种形式不是最重要的问题, 关键是团队所有成员都有一致的认识, 无论是写代码还是**Debug**都能快速切入.

围绕上面三个特质, 作者一一分析对比了传统MVC, Apple MVC, MVP, MVVM, VIPER在这三方面的表现, 结论是到底选用那个纯粹是个人口味问题. 相较于结论, 作者对各个Pattern的角色定义以及分析才是真正有价值的部分, 我们在阅读评断其他类似架构文章的时候, 也应该重在了解作者对于角色的理解. 大家可以基于这一点, 阅读下其他一些类似的文章, **VIPER**理论上并不能归类于MV(X)系列, 而是突破了**MVC**的思考方式, 比如定义了**Router**处理页面流程, 这对架构师是个很好的思路, 在对MV(X)重新设计的时候也应该能有新的思考.

MV(X)都是以MVC为原型进行变化, MV(X)到底如何使用没有教科书式的标准答案, 关键在于架构师和团队各个成员能达成一致的认识， 再遇到问题时能不断的做调整重构, 遇到难以逾越的瓶颈时, 能跳出MV(X)寻找解决方案.

####第二类样本:

在开始分析第二类样本之前，有几个概念比较重要, 是我们深入讨论各个综合型样本的前提. **组件**, **模块**, **层的定义**.

在我看来, 组件是比模块更小的功能单位, 不具备业务属性, 只处理基础通用的问题, 类似于工具箱. 比如我们给NSString写的Category提供base64, 给NSDate写的Category做日期格式化等等.

模块较之组件粒度更大一些, 另外最重要的区别是带有业务属性, 和业务场景相关联. 比如购物车模块, 注册登录模块, 支付模块等等, 模块往往会对一些通用的组件产生依赖.

层是另一个维度的概念了.可以用一张图来区分模块与层的概念:
![](https://ws1.sinaimg.cn/large/006tKfTcgy1frl0wg2l2lj30et07ut8j.jpg)

对于层不允许跨层访问, 也就是说A不能直接访问C, 下层不允许访问上层,B无法知道A的实现细节. 层的概念可类比**TCP/IP**的协议栈. 模块就灵活多了, A, B, C三者之间可以任意访问依赖, 所以一般来说层对架构的约束更高, 但使得依赖更规范好维护, 模块在复杂的场景下很容易结成一个网状的的依赖形态, 难以维护. 第二类项目架构都是围绕层与模块的划分所展开, 有的有严格的层次结构, 有的不分层次， 通过接口严格规范各个模块交互, 有的二者结合, 在某一层内再做模块划分, 下面我们分析的样本都属于上面三种情型:

样本名: 饿了么移动APP的架构演进
[原文地址](https://www.jianshu.com/p/2141fb0dc62c)

这篇架构演进的讲解是典型的从第一步到第二部的过渡:
1. 使用传统MVC快速迭代APP
2. 业务发展, 有多个App需要开发, 开始组件化, 使用**CocoaPods进行组件管理**, 目标是并行开发和代码重用. 架构图如下:
![](https://ws4.sinaimg.cn/large/006tKfTcgy1frl19lr71nj30ku0efaaw.jpg)
3.Hybrid: 几乎所有运营类主导的App最终都会投入到Hybrid的怀抱, 运营团队对快速上线的要求只能在H5或者Hybrid上得以实现， 不过这和架构本身关系不大, 是另一个大的话题.
4. React-Native & Hot Patch, 这和第三步类似都是由运营驱动, 几乎都是所有内容运营型app的必经之路.
5. 这四步的演化文章介绍的还比较粗略, 更多的细节(比如Router内部实现, 业务组件和非业务组件的分工，组件间耦合的方式等)没有介绍.

####第三类样本：
样本名: 携程移动APP架构优化之旅
[原文地址](http://www.docin.com/p-1399719859.html)

携程App端的架构演化在饿了么架构基础之上, 多了很多优化的细节.
提到了对于**基础SDK组件**和**业务组件**的具体划分:

```c
核心功能SDK化
* 通讯，定位，Hybrid, 数据库, 登录, 分享， 基础库等
* 直接提供给其他BU独立APP使用
公用业务功能组件化
* 地图, 日历, 城市, 图片, 通讯录等13个公共组件
* 减少各BU重复开发工作量
```

性能数据指标采集
```c
网络性能: 网络服务成功率, 平均耗时, 耗时分布
定位: 获取经纬度成功率, 城市定位成功率
启动时间, 内存， 流量等指标
多种维度: 系统, App版本，网络状况, 位置等
```
网络优化

```c
使用TCP长连接实现网络服务
根据网络状况2G/3G/4G/WIFI进行调优参数
根据连接/读/写不同阶段使用重试机制
使用IP列表避免DNS解析失败或者劫持
根据网络延迟选择服务端IP(使用Ping)
使用ProtocolBuffer + Gzip减少Payload
```

**Payload**: 通常在传输数据时，为了使数据传输更可靠，要把原始数据分批传输，并且在每一批数据的头和尾都加上一定的辅助信息，比如数据量的大小、校验位等，这样就相当于给已经分批的原始数据加一些外套，这些外套起标示作用，使得原始数据不易丢失，一批数据加上**外套**就形成了传输通道的基本传输单元，叫做数据帧或数据包，而其中的原始数据就是payload

####第四类样本:
样本名: Facebook iOS Architecture
[视频地址1](https://code.facebook.com/videos/232867676889263/facebook-s-ios-infrastructure-mobile-scale/)
[视频地址2](https://www.youtube.com/watch?v=mLSeEoC6GjU)

在关于**Infrastructure(基础设施)**的介绍当中有张示意图介绍团队分工:
![](https://ws1.sinaimg.cn/large/006tKfTcgy1frl1xxfkegj30f207cdga.jpg)

视频当中不光介绍了基础组件, 业务模块的划分, 和说明了这些划分对应的团队是如何进行协作:
* 最底层的是基础设施团队, 负责基础SDK的开发, 可以对应之前谈到的非业务组件.
* 中间层是业务团队,按照业务模块进行划分, 一个业务对应一个团队, 团队负责全平台的开发, 业务团队在开发过程当中可反过来反馈基础SDK
* 最上面的是产品的发布团队, 产品发布团队配合业务团队对产品的发布周期和质量做保障.

##我的思考
将架构的类型归位上述四类也是方便自己搭建关于架构的知识体系, 看架构文章的时候先做好分类再按类别查缺补漏汲取营养. 



